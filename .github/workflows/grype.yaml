# .github/workflows/grype.yaml
name: üì¶ DevSecOps - Dependency Scan (Grype SCA)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  grype_scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: üîé Run Grype Dependency Scan (SCA)
        uses: anchore/scan-action@v6
        id: scan
        # Note: Removing 'continue-on-error: true' and 'severity-cutoff' because we will handle the error in the shell command
        with:
          path: "."
          output-format: json 
          # We must specify the output file name so the next step can find it, 
          # otherwise, the action might not generate the 'output-file' variable on failure.
          output-file: grype-report.json

      - name: üì§ Print Grype Report Content
        # Run the cat command, but force it to succeed using '|| true'
        run: |
          echo "--- START GRYPE REPORT ---"
          cat grype-report.json || true
          echo "--- END GRYPE REPORT ---"
          
      - name: ‚¨ÜÔ∏è Upload Grype Report Artifact
        uses: actions/upload-artifact@v4
        with:
          name: grype-security-report
          path: grype-report.json